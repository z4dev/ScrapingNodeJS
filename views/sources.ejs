<div class="row">
  <!-- Success Alert -->
<div id="successAlert" style="display:none; position:fixed; top:20px; left:20px; z-index:9999; background-color:#28a745; color:white; padding:15px 20px; border-radius:5px; box-shadow:0px 0px 10px rgba(0,0,0,0.3);">
  <i class="fa fa-check-circle"></i> <span id="successMessage">تم جلب عدد من البيانات</span>
</div>

<!-- Error Alert -->
<div id="errorAlert" style="display:none; position:fixed; top:20px; left:20px; z-index:9999; background-color:#dc3545; color:white; padding:15px 20px; border-radius:5px; box-shadow:0px 0px 10px rgba(0,0,0,0.3);">
  <i class="fa fa-times-circle"></i> <span id="errorMessage">لا يوجد أخبار جديدة</span>
</div>

  <div class="col-lg-12">
    <div class="panel panel-default">
      <div class="panel-heading">جميع المصادر المتاحة</div>
      <!-- /.panel-heading -->
      <div class="panel-body">
        <table
          class="table table-striped table-bordered table-hover"
          id="dataTables-sources"
        >
          <thead>
            <tr>
              <th>#</th>
              <th>الاسم</th>
              <th>الرابط</th>
              <th>عدد الأخبار</th>
            </tr>
          </thead>
          <tbody>
            <% sources.forEach(source => { %>
            <tr class="odd gradeX">
              <td><%= source.source_id %></td>
              <td><%= source.source_name %></td>
              <td><%= source.source_url %></td>
              <td style="display: flex; justify-content: space-between; align-items: center;"><%= source.news_count %> 
                <button class="fa fa-reload fa-refresh btn-scraper"></button>

              </td>
            </tr>
            <% }); %>
          </tbody>
        </table>
      </div>
      <!-- /.panel-body -->
    </div>
    <!-- /.panel -->
  </div>
  <!-- /.col-lg-12 -->
</div>
<!-- /.row -->

<!-- Loading Indicator (Initially Hidden) -->
<div id="loadingIndicator" style="display:none; position:fixed; top:50%; left:50%; transform:translate(-50%, -50%); z-index:9999; background-color:white; padding:10px; border-radius:5px; box-shadow:0px 0px 10px rgba(0,0,0,0.5);">
    <i class="fa fa-spinner fa-spin"></i> يتم جلب البيانات...
</div>

<script>
  document.querySelectorAll(".btn-scraper").forEach(button => {
    button.addEventListener("click", async () => {
        try {
            // Show the loading indicator
            document.getElementById("loadingIndicator").style.display = "block";

            const response = await fetch("/sources/scrap", {
                method: "GET",
                headers: {
                    "Content-Type": "application/json",
                },
            });

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const data = await response.json(); 
            const newsCount = data.newsCount;
            const isFetching = data.isFetching;

            // Hide the loading indicator
            document.getElementById("loadingIndicator").style.display = "none";

            if (isFetching) {
                showCustomAlert('success', `تم جلب ${newsCount} خبر جديد`);
            } else {
                showCustomAlert('error', "لا يوجد أخبار جديدة");
            }

            // Reload the page after showing the alert
            setTimeout(() => {
                window.location.reload();
            }, 2000);
            
        } catch (error) {
            // Hide the loading indicator in case of an error
            document.getElementById("loadingIndicator").style.display = "none";
            showCustomAlert('error', "حدث خطأ أثناء جلب البيانات، الرجاء المحاولة مرة أخرى");
            console.error("Error fetching the data:", error);
        }
    });
});

function showCustomAlert(type, message) {
    let alertBox;
    if (type === 'success') {
        alertBox = document.getElementById('successAlert');
    } else if (type === 'error') {
        alertBox = document.getElementById('errorAlert');
    }

    alertBox.querySelector('span').textContent = message;
    alertBox.style.display = 'block';

    setTimeout(() => {
        alertBox.style.display = 'none';
    }, 3000); // Hide the alert after 3 seconds
}

</script>
